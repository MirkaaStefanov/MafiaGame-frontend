<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Lobby</title>
    <script>
        const gameId = [[${gameId}]]; // Thymeleaf should render the game ID here
        const token = [[${token}]];  // Thymeleaf should render the token here

        if (!gameId || !token) {
            console.error("Game ID or token is missing!");
        }

        const url = `/game/players?gameId=${gameId}`;

        function fetchPlayers() {
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error fetching players: ${response.status}`);
                }
                return response.json();
            })
            .then(players => updatePlayerList(players))
            .catch(error => console.error("Error:", error));
        }

        function updatePlayerList(players) {
            const playerListContainer = document.getElementById('player-list');
            if (!playerListContainer) {
                console.error("Player list container not found");
                return;
            }

            playerListContainer.innerHTML = ''; // Clear the existing list
            players.forEach(player => {
                const listItem = document.createElement('li');
                listItem.textContent = player.username; // Adjust this based on your User model
                playerListContainer.appendChild(listItem);
            });
        }

        // Poll the server every 5 seconds to get the latest player data
        setInterval(fetchPlayers, 5000);

        // Initial fetch
        fetchPlayers();
    </script>
</head>
<body>
<h1 th:text="${gameId}"></h1>
<form th:action="@{/game/start}" method="post">
    <label for="gameId">Game ID:</label>
    <input type="hidden" id="gameId" th:value="${gameId}" name="gameId" required>

    <label for="killerQuantity">Killer Quantity:</label>
    <input type="number" id="killerQuantity" name="killerQuantity" required>

    <label for="doctorQuantity">Doctor Quantity:</label>
    <input type="number" id="doctorQuantity" name="doctorQuantity" required>

    <label for="policeQuantity">Police Quantity:</label>
    <input type="number" id="policeQuantity" name="policeQuantity" required>

    <button type="submit">Start Game</button>
</form>

<h3>Players in the Game:</h3>
<ul id="player-list">
    <li th:each="player : ${allMafiaPlayers}" class="player-item"
        th:classappend="${player.role == 'NARRATOR' ? ' narrator' : ''} "
        th:text="${player.user.username}">
    </li>
</ul>
</body>
</html>